---
title: "Accepting cryptocurrency using Crypto Wallet"
---

I added URL support for invoice generation, as well as a little invoice tool, directly in my [crypto wallet](https://warashibetrader.github.io/crypto/wallet). Here are four levels of usage, in order of sophistication.

### 1. URL: Invoice a single or static product

The in-wallet tool should suffice to produce the URL you need. For instance, I used the tool to make this [donation link](https://warashibetrader.github.io/crypto/wallet?preferred=XNO&addresses=%257B%2522XNO%2522%253A%2522nano_1gpquwssoy8491ajmxp9cxjb3o38imcxidissob7cxc38o6h6r4d8gg639b7%2522%257D&items=%255B%257B%2522item%2522%253A%2522Donation%2520to%2520the%2520developer%2522%252C%2522XNO%2522%253A%25221%2522%257D%252C%257B%2522item%2522%253A%2522A%2520memo%2522%252C%2522XNO%2522%253A%2522%2522%257D%255D).




### 2. HTML: Create a button opening a new tab

It's not very professional to ask for payment from an in-line link, and possibly disruptive for the link to leave the current website. A little HTML creates a button which opens the invoice in a new tab:

<button id="myInvoiceElement" style="display:block; margin:auto;"><a style="color:#333" target="_blank" href="https://warashibetrader.github.io/crypto/wallet?preferred=XNO&addresses=%257B%2522XNO%2522%253A%2522nano_1gpquwssoy8491ajmxp9cxjb3o38imcxidissob7cxc38o6h6r4d8gg639b7%2522%257D&items=%255B%257B%2522item%2522%253A%2522Donation%2520to%2520the%2520developer%2522%252C%2522XNO%2522%253A%25221%2522%257D%252C%257B%2522item%2522%253A%2522A%2520memo%2522%252C%2522XNO%2522%253A%2522%2522%257D%255D">Donate!</a></button>

Here is the HTML code in plaintext:

	<button style="display:block; margin:auto;">
		<a id="myInvoiceElement" style="color:#333" target="_blank" href="[insert your paymentURL]">Donate!</a>
	</button>


### 3. Javascript: Invoice a dynamically populated shopping cart

If you want to construct an invoice based on say, a customer's shopping cart, then you will need to generate a payment URL on the fly. This will need a tiny bit of javascript. Include the following function in the global scope of your javascript:

	function makePaymentURL(preferred, addresses, items) {
		const url = new URL('https://warashibetrader.github.io/crypto/wallet');
		url.search = new URLSearchParams({preferred:preferred, 
						  addresses:encodeURIComponent(JSON.stringify(addresses)), 
						  items:encodeURIComponent(JSON.stringify(items))});
		return url;
	}

The makePaymentURL function returns the URL for an invoice filled using the three input parameters. Use this URL for your payment link/button. For instance, using the same HTML code for the button from Step 2,

	let preferred = "XNO";
	let addresses = {XNO: "nano_1gpquwssoy8491ajmxp9cxjb3o38imcxidissob7cxc38o6h6r4d8gg639b7"};
	let items = [{item:"Donation to the developer", XNO:"1"}, {item:"A memo"}];  
	
	let dynamicPaymentURL = makePaymentURL(preferred, addresses, items);
	document.getElementById("myInvoiceElement").href = dynamicPaymentURL;
    
    
### 4. More Javascript: Listen for and respond to payment confirmation

You may want to programmatically respond to a customer's payment. One solution is to set up a crypto network websocket to listen directly for payments to your store's wallet address. However, this will not deterministically correlate with invoices recorded to this crypto wallet, especially if for instance, the customer leaves a tip.

This step requires slightly more sophisticated javascript. While we're at it, we may as well start from scratch to marginally improve the cosmetics of the transaction (like shortening the URL). Include the following function in the global scope of your javascript:

	function startPayment(preferred, addresses, items, processTransaction) {	
		let popup = window.open('https://warashibetrader.github.io/crypto/wallet');
		window.addEventListener("message", function(event) { 
			if (event.source == popup && event.data) {
				if (event.data.cue == "readyCue") 
					popup.postMessage({cue:"replyCue", preferred:preferred, 
									   addresses: addresses, 
									   items: items}); 
				if (event.data.cue == "paidCue" && processTransaction) 
					processTransaction(event.data.id);
				if (event.data.cue == "closeCue") 
					popup.close();
			}
		});
	}

The startPayment function initiates a payment based on the first three input parameters. The last parameter should be a function, which will be called when the payment is confirmed. This function has access to a single parameter, which is the transaction ID. For instance, you can use this to confirm the payment on the crypto network directly. (Of course, you want to let your server do this: The client cannot be trusted to run your site's code.)

The following example creates a thank-you alert when the client completes a payment. First, the javascript,

	let preferred = "XNO";
	let addresses = {XNO: "nano_1gpquwssoy8491ajmxp9cxjb3o38imcxidissob7cxc38o6h6r4d8gg639b7"};
	let items = [{item:"Donation to the developer", XNO:"1"}, {item:"A memo"}];  
	function myPaymentResponse(transactionID) {
		alert("Thank you!");
		// Send transactionID to your server. 
		// Have your server verify the transaction on the crypto network directly.
		// Possibly do more after verification.
	}
	
	document.getElementById("jsInvoice").onclick = function() {
		startPayment(preferred, addresses, items, myPaymentResponse);
	};
	
and then the button:

	<button id="jsInvoice" style="display:block; margin:auto;">Donate!</button>

Demo, using exactly the above three blocks of code:

<button id="jsInvoice" style="display:block; margin:auto;">Donate!</button>

<script>	
function startPayment(preferred, addresses, items, processTransaction) {	
	let popup = window.open('https://warashibetrader.github.io/crypto/wallet');
	window.addEventListener("message", function(event) { 
		if (event.source == popup && event.data) {
			if (event.data.cue == "readyCue") 
				popup.postMessage({cue:"replyCue", preferred:preferred, 
								   addresses: addresses, 
								   items: items}); 
			if (event.data.cue == "paidCue" && processTransaction) 
				processTransaction(event.data.id);
			if (event.data.cue == "closeCue") {
				console.log("closeCue received.");
				popup.close();
			}
		}
	});
}
	
let preferred = "XNO";
let addresses = {XNO: "nano_1gpquwssoy8491ajmxp9cxjb3o38imcxidissob7cxc38o6h6r4d8gg639b7"};
let items = [{item:"Donation to the developer", XNO:"1"}, {item:"A memo"}];  
function myPaymentResponse(transactionID) {
	alert("Thank you!");
	// Send transactionID to your server. 
	// Have your server verify the transaction on the crypto network directly.
	// Possibly do more after verification.
}

document.getElementById("jsInvoice").onclick = function() {
	startPayment(preferred, addresses, items, myPaymentResponse);
};
</script>
